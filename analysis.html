<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Analysis</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; }
nav { background-color: #2c3e50; padding: 12px 20px; text-align: center; }
nav a { color: #ecf0f1; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 16px; }
nav a:hover { color: #f39c12; text-decoration: underline; }
h1 { text-align: center; margin-top: 25px; color: #34495e; }
.section { max-width: 1200px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.section h2 { text-align: center; margin-bottom: 20px; }
.chart-container { width: 100%; max-width: 900px; margin: 20px auto; }
.summary-boxes { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
.summary-box { flex: 1 1 200px; padding: 20px; border-radius: 10px; color: white; text-align: center; font-weight: bold; background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.summary-box p { font-size: 1.3em; margin: 10px 0 0 0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav>
 <a href="index.html">Home</a>
  <a href="newloan.html">New Loan</a>
  <a href="analysis.html">Analysis</a>
  <a href="weekly.html">Weekly Payments</a>
  <a href="borrower_summary.html">Borrower Summary</a>
</nav>

<h1>Advanced Loan Analysis</h1>

<div class="summary-boxes">
  <div class="summary-box">
    Total Loans
    <p id="total-loans">LKR 0</p>
  </div>
  <div class="summary-box">
    Total Received
    <p id="total-received">LKR 0</p>
  </div>
  <div class="summary-box">
    Outstanding
    <p id="total-outstanding">LKR 0</p>
  </div>
</div>

<div class="section chart-container">
  <h2>Top Borrowers</h2>
  <canvas id="topBorrowersChart"></canvas>
</div>

<div class="section chart-container">
  <h2>Weekly Collection Trend</h2>
  <canvas id="weeklyTrendChart"></canvas>
</div>

<div class="section chart-container">
  <h2>Paid vs Unpaid Installments</h2>
  <canvas id="paidUnpaidChart"></canvas>
</div>

<script>
const API_URL = "http://127.0.0.1:8000";

function formatLKR(amount){
  return "LKR " + parseFloat(amount).toLocaleString("si-LK", {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Load summary data
async function loadSummary(){
  const loansRes = await fetch(`${API_URL}/loans`);
  const loans = await loansRes.json();
  const paymentsRes = await fetch(`${API_URL}/payments`);
  const payments = await paymentsRes.json();

  let totalLoans = 0;
  let totalReceived = 0;

  loans.forEach(loan => totalLoans += loan.amount * (1 + loan.interest/100));
  payments.forEach(p => totalReceived += p.amount);

  document.getElementById("total-loans").innerText = formatLKR(totalLoans);
  document.getElementById("total-received").innerText = formatLKR(totalReceived);
  document.getElementById("total-outstanding").innerText = formatLKR(totalLoans - totalReceived);

  return {loans, payments};
}

// Top borrowers chart
function renderTopBorrowers(loans){
  const sorted = loans.sort((a,b)=> (b.amount*(1+b.interest/100)) - (a.amount*(1+a.interest/100))).slice(0,10);
  const labels = sorted.map(l => l.borrower);
  const data = sorted.map(l => (l.amount*(1+l.interest/100)).toFixed(2));

  new Chart(document.getElementById('topBorrowersChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Total Loan Amount', data, backgroundColor: '#3498db' }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// Weekly collection trend
function renderWeeklyTrend(loans, payments){
  let weeklyMap = {};
  loans.forEach(loan => {
    for(let i=1; i<=loan.weeks; i++){
      const dueDate = new Date(loan.start_date);
      dueDate.setDate(dueDate.getDate() + 7*i);
      const key = dueDate.toISOString().split('T')[0];
      weeklyMap[key] = weeklyMap[key] || 0;
    }
  });
  payments.forEach(p=>{
    const loan = loans.find(l=>l.id===p.loan_id);
    if(loan){
      const dueDate = new Date(loan.start_date);
      dueDate.setDate(dueDate.getDate() + 7*p.week);
      const key = dueDate.toISOString().split('T')[0];
      weeklyMap[key] = (weeklyMap[key] || 0) + p.amount;
    }
  });

  const labels = Object.keys(weeklyMap).sort();
  const data = labels.map(l=>weeklyMap[l].toFixed(2));

  new Chart(document.getElementById('weeklyTrendChart'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Weekly Collected', data, borderColor: '#2ecc71', fill:false, tension:0.2 }] },
    options: { responsive: true }
  });
}

// Paid vs unpaid chart
function renderPaidUnpaid(loans, payments){
  let paid = 0, unpaid = 0;
  loans.forEach(loan=>{
    paid += payments.filter(p=>p.loan_id===loan.id).length;
    unpaid += loan.weeks - payments.filter(p=>p.loan_id===loan.id).length;
  });

  new Chart(document.getElementById('paidUnpaidChart'), {
    type: 'pie',
    data: {
      labels:['Paid','Unpaid'],
      datasets:[{ data:[paid, unpaid], backgroundColor:['#2ecc71','#e74c3c'] }]
    },
    options:{ responsive:true }
  });
}

async function initAnalysis(){
  const {loans, payments} = await loadSummary();
  renderTopBorrowers(loans);
  renderWeeklyTrend(loans, payments);
  renderPaidUnpaid(loans, payments);
}

window.onload = initAnalysis;
</script>
</body>
</html>
